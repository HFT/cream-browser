#!/bin/sh

PACKAGE="Cream-Browser"
VERSION="unstable"

PREFIX="/usr/local"
SYSCONFDIR="$PREFIX/etc"
TOPDIR=`pwd`
DEBUG=0

MODULES="www ftp about"

while true
do
     case $1 in
          --prefix=*)
               PREFIX="${1#--prefix=}"
               shift
               ;;

          --prefix)
               PREFIX=$2
               shift 2
               ;;

          --sysconfdir=*)
               SYSCONFDIR="${1#--sysconfdir=}"
               shift
               ;;

          --sysconfdir)
               SYSCONFDIR=$2
               shift 2
               ;;

          --enable-*)
               mod="${1#--enable-}"
               MODULES="$MODULES $mod"
               shift
               ;;

          --disable-*)
               mod="${1#--disable-}"
               MODULES="${MODULES/$mod/}"
               shift
               ;;

          --debug)
               DEBUG=1
               shift
               ;;

          *)
               break
               ;;
     esac
done

ARCH=`uname -m`
echo -n "-- Building on $ARCH "
if [ "$DEBUG" = "1" ]; then
     echo "in debug mode"
     CFLAGS="-g -ggdb3 -fno-inline -Wall -Wstrict-prototypes -Wmissing-prototypes -Wpointer-arith -Wno-sign-compare -O2"
else
     echo "in release mode"
     CFLAGS="-Wall -O2"
fi
LDFLAGS=""

# Check CC
if [ "x$CC" = "x" ]; then
     CC="gcc"
fi

echo -n "-- Checking for compiler ($CC) ... "
compiler=`which $CC`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     echo "yes"
fi

# Check pkg-config
echo -n "-- Checking for pkg-config ... "
which pkg-config > /dev/null 2>&1
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     echo "yes"
fi

# Check sed
echo -n "-- Checking for sed ... "
SED=`which sed`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     echo "yes"
fi

# Check for glib
echo -n "-- Checking for library glib-2.0 ... "
GLIB_VERSION=`pkg-config --modversion glib-2.0`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     echo "$GLIB_VERSION"
fi

# Check for gtk
echo -n "-- Checking for library gtk+-2.0 ... "
GTK_VERSION=`pkg-config --modversion gtk+-2.0`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     echo "$GTK_VERSION"
fi

# Check for lua
echo -n "-- Checking for library lua ... "
LUA_VERSION=`pkg-config --modversion lua`
if [ "$?" = "1" ]; then
     echo "no" && exit 1
else
     echo "$LUA_VERSION"
fi

# -- common.mk
echo -n "Creating: common.mk"
$SED -e "s:@cc@:$compiler:
         s:@cflags@:$CFLAGS:
         s:@ldflags@:$LDFLAGS:
         s:@modules@:$MODULES:
         s:@topdir@:$TOPDIR:
         s:@prefix@:$PREFIX:
         s:@sysconfdir@:$SYSCONFDIR:
         s:@VERSION@:$VERSION:" common.mk.in > common.mk

if [ "$?" = "1" ]; then
     echo " [ failed ]" && exit 1
else
     echo " [ ok ]"
fi

if [ "$DEBUG" = "1" ]; then
     echo "export DEBUG = 1" >> common.mk
fi

# -- cream-browser_build.h
echo -n "Creating: cream-browser_build.h"
$SED -e "s:@HAVE_DEBUG@:$DEBUG:
         s:@GLIB_VERSION@:$GLIB_VERSION:
         s:@GTK_VERSION@:$GTK_VERSION:
         s:@LUA_VERSION@:$LUA_VERSION:
         s:@cflags@:$CFLAGS:
         s:@ldflags@:$LDFLAGS:
         s:@ARCH@:$ARCH:
         s:@PACKAGE@:$PACKAGE:
         s:@VERSION@:$VERSION:
         s:@modules@:$MODULES:
         s:@prefix@:$PREFIX:
         s:@sysconfdir@:$SYSCONFDIR:" cream-browser_build.h.in > cream-browser_build.h

if [ "$?" = "1" ]; then
     echo " [ failed ]" && exit 1
else
     echo " [ ok ]"
fi
